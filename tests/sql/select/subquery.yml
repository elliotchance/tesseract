tags: subquery select

data:
  empty: []

  some_records:
  - {"a": "b"}
  - {"c": "d"}

tests:
  parser_field:
    sql: SELECT (SELECT 1)

  parser_table:
    sql: SELECT * FROM (SELECT 1) AS t

  not_allowed_anonymous_table:
    sql: SELECT * FROM (SELECT 1)
    error: Anonymous table in FROM clause must have alias.

  explain_two_phase_subselect:
    sql: EXPLAIN SELECT * FROM (SELECT 1 + 2) AS t
    result: {
      "default": [
        {"description": "Full table scan of '<t>'"}
      ],
      "t": [
        {"description": "No table used"},
        {"description": "Expressions: 1 + 2"}
      ]
    }

  two_phase_subselect:
    sql: SELECT * FROM (SELECT 1 + 2) AS t
    result:
    - {"col1": 3}

  explain_field_subselect:
    sql: EXPLAIN SELECT (SELECT 2 * 3) + 1
    result: {
      "default": [
        {"description": "No table used"},
        {"description": "Expressions: <0> + 1"}
      ],
      "0": [
        {"description": "No table used"},
        {"description": "Expressions: 2 * 3"}
      ]
    }

  field_subselect:
    sql: SELECT (SELECT 2 * 3) + 1
    result:
    - {"col1": 7}

  explain_multiple_subselects:
    sql: EXPLAIN SELECT (SELECT 2 * 3) + 1, (SELECT 5)
    result: {
      "default": [
        {"description": "No table used"},
        {"description": "Expressions: <0> + 1, <1>"}
      ],
      "0": [
        {"description": "No table used"},
        {"description": "Expressions: 2 * 3"}
      ],
      "1": [
        {"description": "No table used"},
        {"description": "Expressions: 5"}
      ]
    }

  multiple_subselects:
    sql: SELECT (SELECT 2 * 3) + 1, (SELECT 5)
    result:
    - {"col1": 7, "col2": 5}

  subselect_does_not_need_as_before_alias:
    sql: SELECT * FROM (SELECT 1) t
    as: SELECT * FROM (SELECT 1) AS t

  subtable_with_zero_records_is_allowed:
    data: empty
    sql: SELECT * FROM (SELECT * FROM empty) AS t
    result: []

  subtable_with_several_records_is_allowed:
    data: some_records
    sql: SELECT * FROM (SELECT * FROM some_records) AS b
    result:
    - {"a": "b"}
    - {"c": "d"}

  subselect_zero_rows_is_null:
    data: empty
    sql: SELECT (SELECT * FROM empty)
    result:
    - {"col1": null}

  # subselect_must_return_one_record
  # explain_not_allowed_in_subselect
